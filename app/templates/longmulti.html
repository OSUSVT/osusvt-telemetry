{% extends "base.html" %}
{% block content %}
{% endblock %}
{% block script %}
<script>
$(function () {
    /**
     * Load new data depending on the selected min and max
     */
	{% autoescape off %}{# If we do not disable this temporarily, then it will make the json we are rendering useless #}
	variable_data = {{ variable_data }};
	{% endautoescape %}
	shown_variables = Object.keys(variable_data);
	data_url = '{{ url_for('longmulti_data') }}'+'?'+jQuery.param({'data': shown_variables},true)
	function afterSetExtremes(e) {

        var chart = $('#content').highcharts();

        chart.showLoading('Loading data from server...');
        $.getJSON(data_url + '&' + jQuery.param({'start': Math.round(e.min), 'end': Math.round(e.max)},true), function (ajaxdata) {
				{% for index,data in shown_variables %}
					chart.series[{{ index }}].setData(ajaxdata['{{ data }}']);
				{% endfor %}
                chart.hideLoading();
            });
    }
    // See source code from the JSONP handler at https://github.com/highslide-software/highcharts.com/blob/master/samples/data/from-sql.php
    $.getJSON(data_url, function (data) {
        // create the chart
        $('#content').highcharts('StockChart', {
            chart : {
                type: 'spline',
                zoomType: 'x'
            },

            navigator : {
				adaptToUpdatedData: false,
                enabled: true
            },

            scrollbar: {
                liveRedraw: false
            },

            title: {
                text: '{{ title }}'
            },

            rangeSelector : {
                buttons: [{
                    type: 'hour',
                    count: 1,
                    text: '1h'
                }, {
                    type: 'day',
                    count: 1,
                    text: '1d'
                }, {
                    type: 'all',
                    text: 'All'
                }],
                inputEnabled: false, // it supports only days
                selected : 3 // all
            },

            xAxis : {
                events : {
                    afterSetExtremes : afterSetExtremes
                },
                minRange: 120 * 1000 // one hour
            },

            yAxis: [
			{% for index,data in shown_variables %}
			{
				labels: {
					format: '{value} {{ variables[data].units }}',
					style: {
						color: Highcharts.getOptions().colors[{{ index }}]
					}
				},
				title: {
					text: '{{ variables[data].display }}',
					style: {
						color: Highcharts.getOptions().colors[{{ index }}]
					}
				},
				opposite: {{ "true" if index%2 else "false" }},
				max: {{ variables[data].max }},
                min: {{ variables[data].min }}
            },
			{% endfor %}
			],
			tooltip: {
				shared: true
			},
            series : [
			{% for index,data in shown_variables %}
			{
				name: '{{ variables[data].display }}',
				yAxis: {{ index }},
                data : data['{{ data }}'],
                dataGrouping: {
                    enabled: false
                },
				marker: {
					enabled: false
				},
				tooltip: {
					valueSuffix: '{{ variables[data].units }}'
				}
            },
			{% endfor %}
			]
        });
    });
});

</script>
{% endblock %}